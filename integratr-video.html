<link rel="import" href="bower_components/polymer/polymer.html">
<script src="bower_components/videojs/dist/video-js/video.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>

<!--
Element for providing integrated video

##### Example

    <integratr-video in="00:00:00" out="00:05:00" launchText="launch video" src="movie.mpg" extraImage="image.jpg" extraDatawrapper="" extraText=""></integratr-video>

@element integratr-video
@blurb Element for providing integrated video.
@status alpha
@homepage http://times.github.io/integratr
-->
<polymer-element name="integratr-video" attributes="launchText src in out el extraImage extraDatawrapper extraText">

  <template>

    <link rel="stylesheet" href="integratr-video.css" />
    <link rel="stylesheet" href="bower_components/videojs/dist/video-js/video-js.css" />

    <content>
      <a href="" class="launchIntegratr">{{launchText}}</a>
      <div class="integratr hidden">
        <video id="integratrVideo" class="video-js vjs-default-skin integratr {{class}}"
          controls preload="auto" width="auto" height="auto">
         <source src="{{src}}" type='video/mp4' />
         <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
        </video>
        <template if="{{extraImage}}">
          <img src="{{extraImage}}" width="100%" class="extraImage" />
        </template>

        <template if="{{extraText}}">
          <p class="extraText">{{extraText}}</p>
        </template>

        <template if="{{extraDatawrapper}}">
          <iframe class="extraDatawrapper" src="{{extraDatawrapper}}" frameborder="0" allowtransparency="true" allowfullscreen="allowfullscreen" webkitallowfullscreen="webkitallowfullscreen" mozallowfullscreen="mozallowfullscreen" oallowfullscreen="oallowfullscreen" msallowfullscreen="msallowfullscreen" width="100%" height="auto"></iframe>
        </template>
      </div>
    </content>

  </template>

  <script>

    Polymer('integratr-video', {
      /**
       * The `noevent` event is not actually fired from here,
       * we document it as an example of documenting events.
       *
       * @event noevent
       */

      revealVideo: function() {

      },

      /**
       * The `launchText` attribute specifies what link text to use when launching the video
       *
       * @attribute src
       * @type string
       */
      launchText: 'launch video',

      /**
       * The `src` attribute specifies the path to the video file
       *
       * @attribute src
       * @type string
       */
      src: '',

      /**
       * The `el` attribute specifies which <video> element to target
       *
       * @attribute el
       * @type string
       */
      el: '',

      /**
       * The `in` attribute specifies when to bring the video clip in
       *
       * @attribute in
       * @type string
       */
      in: 0,

      /**
       * The `out` attribute specifies when to bring the video clip out
       *
       * @attribute out
       * @type string
       */
      out: 0,

      ready: function() {
        if (this.el) {
          this.src = document.getElementById(this.el).src;
        }

        // this.items = [];
        //
        // for (var prop in this) {
        //   if (this.hasOwnProperty(prop) && prop.indexOf('extra') > -1) {
        //
        //     this.items.push(prop);
        //   }
        // }
        //
        // console.dir(this.items);

      },

      attached: function() {
        var shadow = this.shadowRoot;
        var launcher = shadow.querySelector('.launchIntegratr');
        var video = videojs(this.$.integratrVideo, {"height":"auto", "width":"auto"}).ready(function(){
          // This bit via https://github.com/videojs/videojs.com/blob/master/contents/js/home.js
          var myPlayer = this;    // Store the video object
          var aspectRatio = 5/12; // Make up an aspect ratio

          function resizeVideoJS(){
            // Get the parent element's actual width
            var width;

            try {
              width = document.getElementById(myPlayer.id()).parentElement.offsetWidth;
            } catch(err) {
              width = window.innerWidth;
            }

            // Set width to fill parent element, Set height
            myPlayer.width(width).height( width * aspectRatio );
          }

          resizeVideoJS(); // Initialize the function
          window.onresize = resizeVideoJS; // Call the function on resize
        });

        var inTime = this.in;
        var outTime = this.out;
        launcher.addEventListener('click', function(e) {
          e.preventDefault();
          video.currentTime(inTime);
          //launcher.className = "hidden";
          shadow.querySelector('div.integratr.hidden').className = "integratr visible";
        });

        video.on('timeupdate', function(){
          if (this.currentTime() >= outTime) {
            video.pause();
          }
        });
      }

    });

  </script>

</polymer-element>
